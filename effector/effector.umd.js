((e,t)=>{'object'==typeof exports&&'undefined'!=typeof module?t(exports):'function'==typeof define&&define.amd?define(['exports'],t):t((e='undefined'!=typeof globalThis?globalThis:e||self).effector={})})(this,(e=>{function t(e,t,r,a){(L(e)||W(e))&&('family'in e||'graphite'in e)||H(`${t}: expect ${r} to be a unit (store, event or effect)${a}`)}function r(e,r,a){if(Array.isArray(e))for(let n=0;n<e.length;n++)t(e[n],r,`${n} item of ${a}`,'');else t(e,r,a,' or array of units')}function a(e,t){je={parent:je,value:e,template:Ae(e,'template')||Ce(),sidRoot:Ae(e,'sidRoot')||je&&je.sidRoot};try{return t()}finally{je=Se(je)}}function n({node:e=[],from:t,source:r,parent:a=t||r,to:n,target:o,child:l=n||o,scope:s={},meta:i={},family:f={type:'regular'},regional:c}={}){let u=Ie(a),d=Ie(f.links),p=Ie(f.owners),m=[];for(let t=0;t<e.length;t++){let r=e[t];r&&m.push(r)}let g={id:Q(),seq:m,next:Ie(l),meta:i,scope:s,family:{type:f.type||M,links:d,owners:p}};for(let e=0;e<d.length;e++)ge(d[e]).push(g);for(let e=0;e<p.length;e++)he(p[e]).push(g);for(let e=0;e<u.length;e++)u[e].next.push(g);return c&&je&&Me(ve(je),[g]),g}function o(e,t){for(let r in e)t(e[r],r)}function l(e,t){e.forEach(t)}function s(e,t,r){let a=We,n=null,o=Be;if(e.target&&(t=e.params,r=e.defer,a='page'in e?e.page:a,e.stack&&(n=e.stack),o=xe(e)||o,e=e.target),o&&Be&&o!==Be&&(Be=null),Array.isArray(e))for(let r=0;r<e.length;r++)Re('pure',a,me(e[r]),n,t[r],o);else Re('pure',a,me(e),n,t,o);if(r&&!He)return;let l,s,i,f,c,u,d={isRoot:He,currentPage:We,forkPage:Be,isWatch:Le};He=0;e:for(;f=Ee();){let{idx:e,stack:t,type:r}=f;i=t.node,We=c=t.page,Be=xe(t),c?u=c.reg:Be&&(u=Be.reg);let a=!!c,n=!!Be,o={fail:0,scope:i.scope};l=s=0;for(let f=e;f<i.seq.length&&!l;f++){let p=i.seq[f];switch(p.type){case N:{let{priority:a,barrierID:n}=p.data,o=c?`${c.fullID}_${n}`:n;if(f!==e||r!==a){Te.has(o)||(Te.add(o),ze(f,t,a,n));continue e}Te.delete(o);break}case'mov':{let e,r=p.data;switch(r.from){case C:e=ve(t);break;case D:case'b':e=t[r.from];break;case I:e=r.store;break;case v:if(u&&!u[r.store.id])if(a){let e=Je(c,r.store.id);t.page=c=e,e?u=e.reg:n?(Qe(Be,r.store),u=Be.reg):u=void 0}else n&&Qe(Be,r.store);e=fe(u&&u[r.store.id]||r.store)}switch(r.to){case C:t.value=e;break;case D:case'b':t[r.to]=e;break;case v:Ke(c,Be,i,r.target).current=e}break}case'check':s=ve(t)===('defined'===p.data.type?void 0:fe(Ke(c,Be,i,p.data.store)));break;case F:s=!Xe(o,p.data,t);break;case'run':if(f!==e||r!==S){ze(f,t,S);continue e}case'compute':Le='watch'===Ae(i,'op'),t.value=Xe(o,p.data,t),Le=d.isWatch}l=o.fail||s}if(!l){for(let e=0;e<i.next.length;e++)Re('child',c,i.next[e],t,ve(t),xe(t));let e=xe(t);if(e){Ae(i,'needFxCounter')&&Re('child',c,e.fxCount,t,0,e),Ae(i,'storeChange')&&Re('child',c,e.storeChange,t,0,e);let r=e.additionalLinks[i.id];if(r)for(let a=0;a<r.length;a++)Re('child',c,r[a],t,ve(t),e)}}}He=d.isRoot,We=d.currentPage,Be=xe(d)}function i(e,t="combine"){let r=t+'(',a='',n=0;return o(e,(e=>{n<25&&(null!=e&&(r+=a,r+=O(e)?Ye(e).fullName:e.toString()),n+=1,a=', ')})),r+')'}function f(e,t){let r,a,n=e;if(t){let n=Ye(t);0===e.length?(r=n.path,a=n.fullName):(r=n.path.concat([e]),a=0===n.fullName.length?e:n.fullName+'/'+e)}else r=0===e.length?[]:[e],a=e;return{shortName:n,fullName:a,path:r}}function c(e,...t){let r=Ce();if(r){let a=r.handlers[e];if(a)return a(r,...t)}}function u(e,t){let r=(e,...t)=>We?((e,t,r,a)=>{let n=We,o=null;if(t)for(o=We;o&&o.template!==t;)o=Se(o);Ge(o);let l=e.create(r,a);return Ge(n),l})(r,a,e,t):r.create(e,t);r.graphite=n({meta:pt(w,r,t,e),regional:1}),r.create=e=>(s({target:r,params:e,forkPage:Be}),e),r.watch=X(ft,r),r.map=e=>gt(r,j,e,[ae({fn:pe})]),r.filter=e=>gt(r,F,e.fn?e:e.fn,[ne({fn:pe})]),r.filterMap=e=>gt(r,'filterMap',e,[ae({fn:pe}),re.defined()]),r.prepend=e=>{let t=u('* \u2192 '+r.shortName,{parent:Se(r)});return c('eventPrepend',me(t)),lt(t,r,{scope:{fn:e},node:[ae({fn:pe})],meta:{op:'prepend'}}),dt(r,t),t};let a=Ce();return r}function d(e,t){function a(e,t){u.off(e),we(u).set(e,ot(ht(e,u,'on',1,t,m)))}let o=ie(e),l=ie(e),i=mt('updates');c('storeBase',o,l);let f=o.id,u={subscribers:new Map,updates:i,defaultState:e,stateRef:o,getState(){let e,t=o;if(We){let t=We;for(;t&&!t.reg[f];)t=Se(t);t&&(e=t)}return!e&&Be&&(Qe(Be,o,1),e=Be),e&&(t=e.reg[f]),fe(t)},setState(e){s({target:u,params:e,defer:1,forkPage:Be})},reset(...e){for(let t of e)u.on(t,(()=>u.defaultState));return u},on(e,t){if(r(e,'.on','first argument'),Array.isArray(e))for(let r of e)a(r,t);else a(e,t);return u},off(e){let t=we(u).get(e);return t&&(t(),we(u).delete(e)),u},map(e,t){let r,a;L(e)&&(r=e,e=e.fn),void 0!==t&&console.error('second argument of store.map is deprecated, use updateFilter instead');let n=u.getState();Ce()?a=null:void 0!==n&&(a=e(n,t));let l=d(a,{name:`${u.shortName} \u2192 *`,[_]:r,strict:0}),s=ht(u,l,j,0,e);return ce(ye(l),{type:j,fn:e,from:o}),ye(l).noInit=1,c('storeMap',o,s),l},watch(e,t){if(!t||!O(e)){let t=ft(u,e);return c('storeWatch',o,e)||e(u.getState()),t}return W(t)||H('second argument should be a function'),e.watch((e=>t(u.getState(),e)))}},p=pt(v,u,t),m=u.defaultConfig.updateFilter;return u.graphite=n({scope:{state:o},node:[re.defined(),re.changed({store:l}),m&&te({store:l,to:D}),m&&ne({fn:(e,t,{a:r})=>m(e,r)}),le({store:o}),le({store:l})],child:i,meta:p,regional:1}),p.sid&&(p.storeChange=1,o.sid=p.sid),ut&&void 0===e&&H("current state can't be undefined, use null instead"),Me(u,[i]),u}function p(...e){let t,r,a;Ze(e[0],((t,r)=>{a=t,e=r}));let n,o,l,s=e[e.length-1];if(W(s)?(r=e.slice(0,-1),t=s):r=e,1===r.length){let e=r[0];E(e)||(n=e,o=1)}if(!o&&(n=r,t)){l=1;let e=t;t=t=>e(...t)}return L(n)||H('shape should be an object'),yt(Array.isArray(n),!l,n,a,t)}function m(){let e={};return e.req=new Promise(((t,r)=>{e.rs=t,e.rj=r})),e.req.catch((()=>{})),e}function g(e,t){let r=u(e,t),a=r.defaultConfig.handler||(()=>H(`no handler used in ${r.getType()}`)),o=me(r);Pe(o,'unit',r.kind=S),r.use=e=>(W(e)||H('.use argument should be a function'),a=e,r);let l=r.finally=mt('finally'),i=r.done=l.filterMap({named:'done',fn({status:e,params:t,result:r}){if('done'===e)return{params:t,result:r}}}),f=r.fail=l.filterMap({named:'fail',fn({status:e,params:t,error:r}){if('fail'===e)return{params:t,error:r}}}),c=r.doneData=i.map({named:'doneData',fn:({result:e})=>e}),p=r.failData=f.map({named:'failData',fn:({error:e})=>e}),g=n({scope:{getHandler:r.use.getCurrent=()=>a,finally:l,handlerId:Ae(o,'sid')},node:[oe({fn({params:e,req:t},{finally:r,getHandler:a,handlerId:n},o){let l,s=bt(e,t,1,r,o),i=bt(e,t,0,r,o);try{let t;t=xe(o)&&xe(o).handlers[n]||a(),l=t(e)}catch(e){return void i(e)}L(l)&&W(l.then)?l.then(s,i):s(l)}})],meta:{op:'fx',fx:'runner'}});o.scope.runner=g,o.seq.push(ae({fn:(e,t,r)=>Se(r)?{params:e,req:{rs(e){},rj(e){}}}:e}),oe({fn:(e,{runner:t},r)=>(s({target:t,params:e,defer:1,forkPage:xe(r)}),e.params)})),r.create=e=>{let t=m(),a={params:e,req:t};if(Be){if(!Le){let e=Be;t.req.finally((()=>{Ue(e)})).catch((()=>{}))}s({target:r,params:a,forkPage:Be})}else s(r,a);return t.req};let h=r.inFlight=d(0,{named:'inFlight'}).on(r,(e=>e+1)).on(l,(e=>e-1));Pe(l,'needFxCounter',1),Pe(r,'needFxCounter',1);let y=r.pending=h.map({fn:e=>e>0,named:'pending'});return Me(r,[l,i,f,c,p,y,h,g]),r}function h(e,t){let a=u(t||i(e,'merge'));return r(e,'merge','first argument'),st({from:e,to:a,meta:{op:'merge'}}),a}function y(...e){let t,a,o,s,[[i,f,m],g]=et(e);void 0===f&&L(i)&&(e=>{let t=0;return l(wt,(r=>{r in e&&(null==e[r]&&H(`sample: ${r} should be defined`),t=1)})),t})(i)&&(f=i.clock,m=i.fn,s=i.greedy,t=i.target,a=i.name,o=i.sid,i=i.source);let y=1;void 0===i&&(r(f,'sample','clock'),Array.isArray(f)&&(f=h(f)),i=f,y=0),y&&!O(i)&&(i=p(i)),void 0===f&&(f=i),r(f,'sample','clock'),a=g||a||i.shortName;let b=!!t;if(t||(E(i)&&E(f)?t=d(m?m(fe(ye(i)),fe(ye(f))):fe(ye(i)),{name:a,sid:o}):(t=u(a),c('sampleTarget',me(t)))),E(i)){let e=ye(i);Me(i,[lt(f,t,{scope:{fn:m},node:[c('sampleSourceLoader'),!s&&ee({priority:P}),te({store:e,to:m?D:C}),m&&ae({fn:de}),c('sampleSourceUpward',b)],meta:{op:q,sample:v}})]),c('sampleStoreSource',e)}else{let e=ie(0),r=ie(),a=ie();c('sampleNonStoreSource',e,r,a),n({parent:i,node:[le({store:r}),te({from:I,store:1,target:e})],family:{owners:[i,t,f],links:t},meta:{op:q,sample:'source'},regional:1}),Me(i,[lt(f,t,{scope:{fn:m},node:[c('sampleSourceLoader'),le({store:a}),te({store:e}),ne({fn:e=>e}),!s&&ee({priority:P}),te({store:r}),te({store:a,to:D}),m&&ae({fn:ue}),c('sampleSourceUpward',b)],meta:{op:q,sample:'clock'}})])}return t}function b(e,t){if(Array.isArray(e)&&(e=new Map(e)),e instanceof Map){let r={};for(let[a,n]of e)O(a)||H('Map key should be a unit'),t&&t(a,n),r[a.sid]=n;return r}return e}let k='undefined'!=typeof Symbol&&Symbol.observable||'@@observable',v='store',w='event',S='effect',x='domain',A='scope',P='sampler',M='crosslink',j='map',C='stack',N='barrier',I='value',q='sample',F='filter',D='a',_="\u0254",O=e=>(W(e)||L(e))&&'kind'in e;const $=e=>t=>O(t)&&t.kind===e;let E=$(v),R=$(w),z=$(S),V=$(x),T=$(A);var B={__proto__:null,unit:O,store:E,event:R,effect:z,domain:V,scope:T};let H=e=>{throw Error(e)},L=e=>'object'==typeof e&&null!==e,W=e=>'function'==typeof e,U=e=>{L(e)||W(e)||H('expect first argument be an object')};const G=()=>{let e=0;return()=>""+ ++e};let J=G(),K=G(),Q=G(),X=(e,t)=>e.bind(null,t);const Y=(e,t)=>({id:K(),type:e,data:t});let Z=0,ee=({priority:e=N})=>Y(N,{barrierID:++Z,priority:e}),te=({from:e=v,store:t,target:r,to:a=(r?v:C)})=>Y('mov',{from:e,store:t,to:a,target:r}),re={defined:()=>Y('check',{type:'defined'}),changed:({store:e})=>Y('check',{type:'changed',store:e})},ae=X(Y,'compute'),ne=X(Y,F),oe=X(Y,'run'),le=({store:e})=>te({from:C,target:e});var se={__proto__:null,barrier:ee,mov:te,check:re,compute:ae,filter:ne,run:oe,update:le};let ie=e=>({id:K(),current:e}),fe=({current:e})=>e,ce=(e,t)=>{e.before||(e.before=[]),e.before.push(t)},ue=(e,{fn:t},{a:r})=>t(e,r),de=(e,{fn:t},{a:r})=>t(r,e),pe=(e,{fn:t})=>t(e),me=e=>e.graphite||e,ge=e=>e.family.owners,he=e=>e.family.links,ye=e=>e.stateRef,be=e=>e.config,ke=e=>e["\u0254"],ve=e=>e.value,we=e=>e.subscribers,Se=e=>e.parent,xe=e=>e.forkPage,Ae=(e,t)=>me(e).meta[t],Pe=(e,t,r)=>me(e).meta[t]=r,Me=(e,t)=>{let r=me(e);for(let e=0;e<t.length;e++){let a=me(t[e]);r.family.type!==x&&(a.family.type=M),ge(a).push(r),he(r).push(a)}},je=null,Ce=()=>je&&je.template,Ne=e=>(e&&je&&je.sidRoot&&(e=`${je.sidRoot}\u0254${e}`),e);const Ie=(e=[])=>(Array.isArray(e)?e:[e]).flat().map(me);let qe=(e,t)=>e.includes(t),Fe=(e,t)=>{let r=e.indexOf(t);-1!==r&&e.splice(r,1)},De=null;const _e=(e,t)=>{if(!e)return t;if(!t)return e;let r,a=e.v.type===t.v.type;return(a&&e.v.id>t.v.id||!a&&e.v.type===P)&&(r=e,e=t,t=r),r=_e(e.r,t),e.r=e.l,e.l=r,e},Oe=[];let $e=0;for(;$e<5;)Oe.push({first:null,last:null,size:0}),$e+=1;const Ee=()=>{for(let e=0;e<5;e++){let t=Oe[e];if(t.size>0){if(2===e||3===e){t.size-=1;let e=De.v;return De=_e(De.l,De.r),e}1===t.size&&(t.last=null);let r=t.first;return t.first=r.r,t.size-=1,r.v}}},Re=(e,t,r,a,n,o)=>ze(0,{a:null,b:null,node:r,parent:a,value:n,page:t,forkPage:o},e),ze=(e,t,r,a=0)=>{let n=Ve(r),o=Oe[n],l={v:{idx:e,stack:t,type:r,id:a},l:null,r:null};2===n||3===n?De=_e(De,l):(0===o.size?o.first=l:o.last.r=l,o.last=l),o.size+=1},Ve=e=>{switch(e){case'child':return 0;case'pure':return 1;case N:return 2;case P:return 3;case S:return 4;default:return-1}},Te=new Set;let Be,He=1,Le=0,We=null,Ue=e=>{Be=e},Ge=e=>{We=e};const Je=(e,t)=>{if(e){for(;e&&!e.reg[t];)e=Se(e);if(e)return e}return null};let Ke=(e,t,r,a,n)=>{let o=Je(e,a.id);return o?o.reg[a.id]:t?(Qe(t,a,n),t.reg[a.id]):a},Qe=(e,t,r)=>{let a=e.reg;if(a[t.id])return;let n={id:t.id,current:t.current};if(t.sid&&(e.sidIdMap[t.sid]=t.id),t.sid&&t.sid in e.sidValuesMap)n.current=e.sidValuesMap[t.sid];else if((r||!t.noInit)&&t.before){let o=0;l(t.before,(t=>{switch(t.type){case j:{let o=t.from;if(o||t.fn){o&&Qe(e,o,r);let l=o&&a[o.id].current;n.current=t.fn?t.fn(l):l}break}case'field':{Qe(e,t.from,r);let l=a[t.from.id];o||(o=1,n.current=Array.isArray(n.current)?[...n.current]:{...n.current}),n.current[t.field]=a[l.id].current;break}}}))}a[t.id]=n};const Xe=(e,{fn:t},r)=>{try{return t(ve(r),e.scope,r)}catch(t){console.error(t),e.fail=1}},Ye=e=>e.compositeName;let Ze=(e,t)=>{U(e),ke(e)&&t(be(e),ke(e))},et=e=>{let t;return Ze(e[0],((r,a)=>{t=r,e=a})),[e,t]};const tt=(e,t)=>{Fe(e.next,t),Fe(ge(e),t),Fe(he(e),t)},rt=(e,t,r)=>{let a;e.next.length=0,e.seq.length=0,e.scope=null;let n=he(e);for(;a=n.pop();)tt(a,e),(t||r&&!Ae(e,'sample')||a.family.type===M)&&rt(a,t,'on'!==Ae(a,'op')&&r);for(n=ge(e);a=n.pop();)tt(a,e),r&&a.family.type===M&&rt(a,t,'on'!==Ae(a,'op')&&r)},at=e=>e.clear();let nt=(e,{deep:t}={})=>{let r=0;if(e.ownerSet&&e.ownerSet.delete(e),E(e))at(we(e));else if(V(e)){r=1;let t=e.history;at(t.events),at(t.effects),at(t.stores),at(t.domains)}rt(me(e),!!t,r)},ot=e=>{let t=()=>nt(e);return t.unsubscribe=t,t},lt=(e,t,{node:r,scope:a,meta:o})=>n({node:r,parent:e,child:t,scope:a,meta:o,family:{owners:[e,t],links:t},regional:1}),st=e=>{let t;Ze(e,((r,a)=>{t=r,e=a}));let{from:a,to:o,meta:l={op:'forward'}}=e;return r(a,'forward','"from"'),r(o,'forward','"to"'),t&&(l.config=t),ot(n({parent:a,child:o,meta:l,family:{},regional:1}))},ft=(e,t)=>(W(t)||H('.watch argument should be a function'),ot(n({scope:{fn:t},node:[oe({fn:pe})],parent:e,meta:{op:'watch'},family:{owners:e},regional:1})));const ct=(e,t)=>(L(e)&&(ct(be(e),t),null!=e.name&&(L(e.name)?ct(e.name,t):W(e.name)?t.handler=e.name:t.name=e.name),e.loc&&(t.loc=e.loc),(e.sid||null===e.sid)&&(t.sid=e.sid),e.handler&&(t.handler=e.handler),e.updateFilter&&(t.updateFilter=e.updateFilter),Se(e)&&(t.parent=Se(e)),'strict'in e&&(t.strict=e.strict),e.named&&(t.named=e.named),ct(ke(e),t)),t);let ut,dt=(e,t,r=w)=>{Se(e)&&Se(e).hooks[r](t)},pt=(e,t,r,a)=>{let n=ct({name:a,config:r},{}),o=e===x,l=J(),{parent:s=null,sid:i=null,strict:c=1,named:u=null}=n,d=u||n.name||(o?'':l),p=f(d,s),m={unit:t.kind=e,name:t.shortName=d,sid:t.sid=Ne(i),named:u,unitId:t.id=l};if(t.parent=s,t.compositeName=p,t.defaultConfig=n,t.thru=e=>e(t),t.getType=()=>p.fullName,!o){t.subscribe=e=>(U(e),t.watch(W(e)?e:t=>{e.next&&e.next(t)})),t[k]=()=>t;let e=Ce();e&&(m.nativeTemplate=e)}return ut=c,m},mt=e=>u({named:e});const gt=(e,t,r,a)=>{let n;L(r)&&(n=r,r=r.fn);let o=u({name:`${e.shortName} \u2192 *`,[_]:n});return lt(e,o,{scope:{fn:r},node:a,meta:{op:t}}),o},ht=(e,t,r,a,n,o)=>{let l=ye(t),s=[te({store:l,to:D}),ae({fn:a?de:ue}),re.defined(),re.changed({store:l}),o&&ne({fn:(e,t,{a:r})=>o(e,r)}),le({store:l})];return c('storeOnMap',l,s,E(e)&&ye(e)),lt(e,t,{scope:{fn:n},node:s,meta:{op:r}})},yt=(e,t,r,a,n)=>{let l=e?e=>e.slice():e=>({...e}),s=e?[]:{},f=l(s),u=ie(f),p=ie(1);u.type=e?'list':'shape',u.noInit=1,c('combineBase',u,p);let m=d(f,{name:a||i(r)}),g=ye(m);g.noInit=1,Pe(m,'isCombine',1);let h=[re.defined(),te({store:u,to:D}),ne({fn:(e,{key:t},{a:r})=>e!==r[t]}),te({store:p,to:'b'}),ae({fn(e,{clone:t,key:r,spread:a},n){a&&n.b&&(n.a=t(n.a)),n.a[r]=e}}),te({from:D,target:u}),te({from:I,store:0,target:p}),ee({priority:N}),te({from:I,store:1,target:p}),te({store:u}),n&&ae({fn:pe}),re.changed({store:g})];return o(r,((e,r)=>{if(!E(e))return void(f[r]=s[r]=e);s[r]=e.defaultState,f[r]=e.getState();let a=lt(e,m,{scope:{key:r,clone:l,fn:n,spread:t},node:h,meta:{op:'combine'}}),o=ye(e);ce(u,{type:'field',field:r,from:o}),c('combineField',o,a)})),m.defaultShape=r,ce(g,{type:j,from:u,fn:n}),Ce()||(m.defaultState=n?g.current=n(f):s),m};let bt=(e,t,r,a,n)=>o=>s({target:[a,kt],params:[r?{status:'done',params:e,result:o}:{status:'fail',params:e,error:o},{fn:r?t.rs:t.rj,value:o}],defer:1,page:n.page,forkPage:xe(n)}),kt=n({node:[oe({fn({fn:e,value:t}){e(t)}})],meta:{op:'fx',fx:'sidechain'}});const vt=(e,t,r)=>(e.create=t=>(s(e,t),t),me(e).seq.push(ae({fn:(e,t,r)=>(r.forkPage=null,e)})),e.watch((e=>{Me(r,[e]),t.add(e),e.ownerSet||(e.ownerSet=t),Se(e)||(e.parent=r)})),Me(r,[e]),r=>(t.forEach(r),e.watch(r))),wt=['source','clock','target'],St=(e,t,r,a)=>{let n=e[t];n&&s({target:n,params:Array.isArray(n)?n.map((()=>r)):r,defer:1,stack:a})};e.allSettled=(e,{scope:t,params:r})=>{if(!O(e))return Promise.reject(Error('first argument should be unit'));let a=m();a.parentFork=Be;let{fxCount:n}=t;n.scope.defers.push(a);let o=[e],l=[];return z(e)?l.push({params:r,req:{rs(e){a.value={status:'done',value:e}},rj(e){a.value={status:'fail',value:e}}}}):l.push(r),o.push(n),l.push(null),s({target:o,params:l,forkPage:t}),a.req},e.attach=e=>{let t;Ze(e,((r,a)=>{t=r,e=a}));let{source:r,effect:a,mapParams:n}=e,o=!z(a)&&W(a);if(n||(n=r&&!o?(e,t)=>t:e=>e),o){let e=a;a=g((([t,r])=>e(t,r)))}let l=g(e,t);Pe(l,'attached',1);let i,{runner:f}=me(l).scope,c=({params:e,req:t},{finally:r,effect:a,isPlain:o},l)=>{let i,f=bt(e,t,0,r,l);try{i=n(e,l.a)}catch(e){return f(e)}s({target:a,params:{params:o?[i,l.a]:i,req:{rs:bt(e,t,1,r,l),rj:f}},page:l.page,defer:1})};if(r){let e;E(r)?(e=r,Me(r,[l])):(e=p(r),Me(l,[e])),i=[oe({fn:e=>e}),te({store:ye(e),to:D}),ae({fn:c})]}else i=[oe({fn:c})];return Me(a,[l]),f.scope.effect=a,f.scope.isPlain=o,f.seq.splice(0,1,...i),dt(a,l,S),l},e.clearNode=nt,e.combine=p,e.createApi=(...e)=>{let[[t,r],a]=et(e),n={};return o(r,((e,r)=>{let o=n[r]=u(r,{parent:Se(t),config:a});t.on(o,e),dt(t,o)})),n},e.createDomain=function e(t,r){let a=new Set,l=new Set,s=new Set,i=new Set,f=n({family:{type:x},regional:1}),c={history:{domains:a,stores:l,effects:s,events:i},graphite:f};f.meta=pt(x,c,r,t);let[p,m,h,y]=['onEvent','onEffect','onStore','onDomain'].map(mt);c.hooks={event:p,effect:m,store:h,domain:y},c.onCreateEvent=vt(p,i,c),c.onCreateEffect=vt(m,s,c),c.onCreateStore=vt(h,l,c),c.onCreateDomain=vt(y,a,c),c.createEvent=c.event=(e,t)=>p(u(e,{parent:c,config:t})),c.createEffect=c.effect=(e,t)=>m(g(e,{parent:c,config:t})),c.createDomain=c.domain=(t,r)=>e({name:t,parent:c,config:r}),c.createStore=c.store=(e,t)=>h(d(e,{parent:c,config:t}));let b=Se(c);return b&&(o(c.hooks,((e,t)=>{st({from:e,to:b.hooks[t]})})),b.hooks.domain(c)),c},e.createEffect=g,e.createEvent=u,e.createNode=n,e.createStore=d,e.createStoreObject=(...e)=>(console.error('createStoreObject is deprecated, use combine instead'),p(...e)),e.fork=(e,t)=>{let r,a=e;V(e)&&(r=e,a=t);let o=(e=>{let t=n({scope:{defers:[],inFlight:0,fxID:0},node:[ae({fn(e,t,r){Se(r)?'finally'===Ae(Se(r).node,'named')?t.inFlight-=1:(t.inFlight+=1,t.fxID+=1):t.fxID+=1}}),ee({priority:P}),oe({fn(e,t){let{inFlight:r,defers:a,fxID:n}=t;r>0||0===a.length||Promise.resolve().then((()=>{t.fxID===n&&l(a.splice(0,a.length),(e=>{Ue(e.parentFork),e.rs(e.value)}))}))}})],meta:{unit:"forkInFlightCounter"}}),r=n({node:[ae({fn(e,t,r){let a=Se(r);if(a&&Se(a)){let t=a.node;if(!Ae(t,'isCombine')||'combine'!==Ae(Se(a).node,'op')){let a=xe(r),n=t.scope.state.id,o=Ae(t,'sid');a.sidIdMap[o]=n,a.sidValuesMap[o]=e}}}})]}),a={cloneOf:e,reg:{},sidValuesMap:{},sidIdMap:{},getState:e=>'current'in e?Ke(We,a,null,e).current:((e,t)=>Ke(We,t,e,e.scope.state,1).current)(me(e),a),kind:A,graphite:n({family:{type:x,links:[t,r]},meta:{unit:'fork'},scope:{forkInFlightCounter:t}}),additionalLinks:{},handlers:{},fxCount:t,storeChange:r};return a})(r);if(a){if(a.values){let e=b(a.values,(e=>!E(e)&&H('Values map can contain only stores as keys')));Object.assign(o.sidValuesMap,e)}a.handlers&&(o.handlers=b(a.handlers,(e=>{z(e)||H("Handlers map can contain only effects as keys"),Ae(e,'attached')&&H('Handlers can`t accept attached effects')})))}return o},e.forward=st,e.fromObservable=e=>{U(e);let t=k in e?e[k]():e;t.subscribe||H('expect observable to have .subscribe');let r=u(),a=ot(r);return t.subscribe({next:r,error:a,complete:a}),r},e.guard=(...e)=>{let t={op:'guard'},a='guard',[[o,l],s]=et(e);s&&(t.config=s,s.name&&(a=s.name)),l||(l=o,o=l.source);let{filter:i,greedy:f,clock:c,name:d=a}=l,m=l.target||u(d,t.config),g=O(i),b=1;return void 0===o&&(r(c,'guard','clock'),Array.isArray(c)&&(c=h(c)),o=c,b=0),b&&!O(o)&&(o=p(o)),c&&(r(c,'guard','clock'),o=y({source:o,clock:c,greedy:f,fn:g?null:(e,t)=>({source:e,clock:t})})),r(m,'guard','target'),g?y({source:i,clock:o,target:n({node:[ne({fn:({guard:e})=>e}),ae({fn:({data:e})=>e})],child:m,meta:t,family:{owners:[o,i,m,...[].concat(c||[])],links:m},regional:1}),fn:(e,t)=>({guard:e,data:t}),greedy:f,name:d}):(W(i)||H('`filter` should be function or unit'),lt(o,m,{scope:{fn:i},node:c?[ne({fn:({source:e,clock:t},{fn:r})=>r(e,t)}),ae({fn:({source:e})=>e})]:[ne({fn:pe})],meta:t})),m},e.hydrate=(e,{values:t})=>{L(t)||H('values property should be an object');let r,a,n=b(t),o=Object.getOwnPropertyNames(n),i=[],f=[];T(e)?(r=e,Object.assign(r.sidValuesMap,n),r.cloneOf||H('scope should be created from domain'),a=me(r.cloneOf)):V(e)?a=me(e):H('first argument of hydrate should be domain or scope'),(e=>{let t=[];(function e(r){qe(t,r)||(t.push(r),Ae(r,'unit')===v&&Ae(r,'sid')&&((e,t)=>{qe(o,t)&&(i.push(e),f.push(n[t]))})(r,Ae(r,'sid')),l(r.next,e),l(ge(r),e),l(he(r),e))})(e)})(a),s({target:i,params:f,forkPage:r})},e.is=B,e.launch=s,e.merge=h,e.restore=(e,t,r)=>{if(E(e))return e;if(O(e)){let a,n=Se(e);return R(e)&&(a=d(t,{parent:n,name:e.shortName,[_]:r}).on(e,((e,t)=>t))),z(e)&&(a=d(t,{parent:n,name:e.shortName,[_]:r}),st({from:e.doneData,to:a})),n&&n.hooks.store(a),a}let a=Array.isArray(e)?[]:{};return o(e,((e,t)=>{a[t]=E(e)?e:d(e,{name:t})})),a},e.sample=y,e.scopeBind=(e,{scope:t}={})=>{t||Be||H('scopeBind cannot be called outside of forked .watch');let r=t||Be;return z(e)?t=>{let a=m();return s({target:e,params:{params:t,req:a},forkPage:r}),a.req}:t=>(s({target:e,params:t,forkPage:r}),t)},e.serialize=(e,{ignore:t=[]}={})=>{let r=t.map((({sid:e})=>e)),a={};return o(e.sidValuesMap,((t,n)=>{if(r.includes(n))return;let o=e.sidIdMap[n];a[n]=o&&o in e.reg?e.reg[o].current:t})),a},e.setStoreName=(e,t)=>{e.shortName=t,Object.assign(Ye(e),f(t,Se(e)))},e.split=(...e)=>{let t,[[r,a],l]=et(e),s=!a;s&&(t=r.cases,a=r.match,r=r.source);let i=E(a),f=!O(a)&&W(a),d=!i&&!f&&L(a);t||(t={}),s||(d||H('match should be an object'),o(a,((e,r)=>{t[r]=u(l)})),t.__=u(l));let p,m=new Set([].concat(r,Object.values(t))),g=Object.keys(i||f?t:a);if(i||f)i&&m.add(a),p=[i&&ee({priority:'sampler'}),i&&te({store:ye(a),to:'a'}),ne({fn(e,t,r){let n=String(i?r.a:a(e));St(t,qe(g,n)?n:'__',e,r)}})];else if(d){let e=ie({});e.type='shape';let t,r=[te({store:e,to:D}),ae({fn(e,{key:t},{a:r}){r[t]=e}})],n=[];o(a,((a,o)=>{if(O(a)){t=1,n.push(o),m.add(a);let l=lt(a,[],{node:r,scope:{key:o}});if(E(a)){e.current[o]=a.getState();let t=ye(a);ce(e,{type:'field',field:o,from:t}),c('splitMatchStore',t,l)}}})),t&&c('splitBase',e),p=[t&&ee({priority:'sampler'}),t&&te({store:e,to:'a'}),ne({fn(e,t,r){for(let o=0;o<g.length;o++){let l=g[o];if(qe(n,l)?r.a[l]:a[l](e))return void St(t,l,e,r)}St(t,'__',e,r)}})]}else H('expect match to be unit, function or object');if(n({meta:{op:'split'},parent:r,scope:t,node:p,family:{type:'crosslink',owners:Array.from(m)},regional:1}),!s)return t},e.step=se,e.version="21.8.12",e.withFactory=({sid:e,name:t,loc:r,method:o,fn:l})=>a(n({meta:{sidRoot:Ne(e),name:t,loc:r,method:o}}),l),e.withRegion=a,Object.defineProperty(e,'__esModule',{value:1})}));
//# sourceMappingURL=effector.umd.js.map
