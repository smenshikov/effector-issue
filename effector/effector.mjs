function e(e,t,r,a){(L(e)||T(e))&&('family'in e||'graphite'in e)||H(`${t}: expect ${r} to be a unit (store, event or effect)${a}`)}function t(t,r,a){if(Array.isArray(t))for(let n=0;n<t.length;n++)e(t[n],r,`${n} item of ${a}`,'');else e(t,r,a,' or array of units')}function r(e,t){Ce={parent:Ce,value:e,template:xe(e,'template')||Me(),sidRoot:xe(e,'sidRoot')||Ce&&Ce.sidRoot};try{return t()}finally{Ce=we(Ce)}}function a({node:e=[],from:t,source:r,parent:a=t||r,to:n,target:o,child:l=n||o,scope:s={},meta:i={},family:f={type:'regular'},regional:c}={}){let u=je(a),d=je(f.links),p=je(f.owners),m=[];for(let t=0;t<e.length;t++){let r=e[t];r&&m.push(r)}let g={id:K(),seq:m,next:je(l),meta:i,scope:s,family:{type:f.type||"crosslink",links:d,owners:p}};for(let e=0;e<d.length;e++)me(d[e]).push(g);for(let e=0;e<p.length;e++)ge(p[e]).push(g);for(let e=0;e<u.length;e++)u[e].next.push(g);return c&&Ce&&Pe(ke(Ce),[g]),g}function n(e,t){for(let r in e)t(e[r],r)}function o(e,t){e.forEach(t)}function l(e,t,r){let a=We,n=null,o=He;if(e.target&&(t=e.params,r=e.defer,a='page'in e?e.page:a,e.stack&&(n=e.stack),o=Se(e)||o,e=e.target),o&&He&&o!==He&&(He=null),Array.isArray(e))for(let r=0;r<e.length;r++)Re('pure',a,pe(e[r]),n,t[r],o);else Re('pure',a,pe(e),n,t,o);if(r&&!Le)return;let l,s,i,f,c,u,d={isRoot:Le,currentPage:We,forkPage:He,isWatch:Te};Le=0;e:for(;f=Ee();){let{idx:e,stack:t,type:r}=f;i=t.node,We=c=t.page,He=Se(t),c?u=c.reg:He&&(u=He.reg);let a=!!c,n=!!He,o={fail:0,scope:i.scope};l=s=0;for(let f=e;f<i.seq.length&&!l;f++){let p=i.seq[f];switch(p.type){case"barrier":{let{priority:a,barrierID:n}=p.data,o=c?`${c.fullID}_${n}`:n;if(f!==e||r!==a){Be.has(o)||(Be.add(o),Ve(f,t,a,n));continue e}Be.delete(o);break}case'mov':{let e,r=p.data;switch(r.from){case"stack":e=ke(t);break;case"a":case'b':e=t[r.from];break;case"value":e=r.store;break;case D:if(u&&!u[r.store.id])if(a){let e=Je(c,r.store.id);t.page=c=e,e?u=e.reg:n?(Qe(He,r.store),u=He.reg):u=void 0}else n&&Qe(He,r.store);e=ie(u&&u[r.store.id]||r.store)}switch(r.to){case"stack":t.value=e;break;case"a":case'b':t[r.to]=e;break;case D:Ke(c,He,i,r.target).current=e}break}case'check':s=ke(t)===('defined'===p.data.type?void 0:ie(Ke(c,He,i,p.data.store)));break;case"filter":s=!Xe(o,p.data,t);break;case'run':if(f!==e||"effect"!==r){Ve(f,t,"effect");continue e}case'compute':Te='watch'===xe(i,'op'),t.value=Xe(o,p.data,t),Te=d.isWatch}l=o.fail||s}if(!l){for(let e=0;e<i.next.length;e++)Re('child',c,i.next[e],t,ke(t),Se(t));let e=Se(t);if(e){xe(i,'needFxCounter')&&Re('child',c,e.fxCount,t,0,e),xe(i,'storeChange')&&Re('child',c,e.storeChange,t,0,e);let r=e.additionalLinks[i.id];if(r)for(let a=0;a<r.length;a++)Re('child',c,r[a],t,ke(t),e)}}}Le=d.isRoot,We=d.currentPage,He=Se(d)}function s(e,t="combine"){let r=t+'(',a='',o=0;return n(e,(e=>{o<25&&(null!=e&&(r+=a,r+=_(e)?Ye(e).fullName:e.toString()),o+=1,a=', ')})),r+')'}function i(e,t){e.shortName=t,Object.assign(Ye(e),f(t,we(e)))}function f(e,t){let r,a,n=e;if(t){let n=Ye(t);0===e.length?(r=n.path,a=n.fullName):(r=n.path.concat([e]),a=0===n.fullName.length?e:n.fullName+'/'+e)}else r=0===e.length?[]:[e],a=e;return{shortName:n,fullName:a,path:r}}function c(e,...t){let r=Me();if(r){let a=r.handlers[e];if(a)return a(r,...t)}}function u(e,t){let r=(e,...t)=>We?((e,t,r,a)=>{let n=We,o=null;if(t)for(o=We;o&&o.template!==t;)o=we(o);Ge(o);let l=e.create(r,a);return Ge(n),l})(r,n,e,t):r.create(e,t);r.graphite=a({meta:pt("event",r,t,e),regional:1}),r.create=e=>(l({target:r,params:e,forkPage:He}),e),r.watch=Q(ft,r),r.map=e=>gt(r,"map",e,[re({fn:de})]),r.filter=e=>gt(r,"filter",e.fn?e:e.fn,[ae({fn:de})]),r.filterMap=e=>gt(r,'filterMap',e,[re({fn:de}),te.defined()]),r.prepend=e=>{let t=u('* \u2192 '+r.shortName,{parent:we(r)});return c('eventPrepend',pe(t)),lt(t,r,{scope:{fn:e},node:[re({fn:de})],meta:{op:'prepend'}}),dt(r,t),t};let n=Me();return r}function d(e,r){function n(e,t){u.off(e),ve(u).set(e,ot(ht(e,u,'on',1,t,m)))}let o=se(e),s=se(e),i=mt('updates');c('storeBase',o,s);let f=o.id,u={subscribers:new Map,updates:i,defaultState:e,stateRef:o,getState(){let e,t=o;if(We){let t=We;for(;t&&!t.reg[f];)t=we(t);t&&(e=t)}return!e&&He&&(Qe(He,o,1),e=He),e&&(t=e.reg[f]),ie(t)},setState(e){l({target:u,params:e,defer:1,forkPage:He})},reset(...e){for(let t of e)u.on(t,(()=>u.defaultState));return u},on(e,r){if(t(e,'.on','first argument'),Array.isArray(e))for(let t of e)n(t,r);else n(e,r);return u},off(e){let t=ve(u).get(e);return t&&(t(),ve(u).delete(e)),u},map(e,t){let r,a;L(e)&&(r=e,e=e.fn),void 0!==t&&console.error('second argument of store.map is deprecated, use updateFilter instead');let n=u.getState();Me()?a=null:void 0!==n&&(a=e(n,t));let l=d(a,{name:`${u.shortName} \u2192 *`,\u0254:r,strict:0}),s=ht(u,l,"map",0,e);return fe(he(l),{type:"map",fn:e,from:o}),he(l).noInit=1,c('storeMap',o,s),l},watch(e,t){if(!t||!_(e)){let t=ft(u,e);return c('storeWatch',o,e)||e(u.getState()),t}return T(t)||H('second argument should be a function'),e.watch((e=>t(u.getState(),e)))}},p=pt(D,u,r),m=u.defaultConfig.updateFilter;return u.graphite=a({scope:{state:o},node:[te.defined(),te.changed({store:s}),m&&ee({store:s,to:"a"}),m&&ae({fn:(e,t,{a:r})=>m(e,r)}),oe({store:o}),oe({store:s})],child:i,meta:p,regional:1}),p.sid&&(p.storeChange=1,o.sid=p.sid),ut&&void 0===e&&H("current state can't be undefined, use null instead"),Pe(u,[i]),u}function p(...e){let t,r,a;Ze(e[0],((t,r)=>{a=t,e=r}));let n,o,l,s=e[e.length-1];if(T(s)?(r=e.slice(0,-1),t=s):r=e,1===r.length){let e=r[0];$(e)||(n=e,o=1)}if(!o&&(n=r,t)){l=1;let e=t;t=t=>e(...t)}return L(n)||H('shape should be an object'),yt(Array.isArray(n),!l,n,a,t)}function m(...e){return console.error('createStoreObject is deprecated, use combine instead'),p(...e)}function g(){let e={};return e.req=new Promise(((t,r)=>{e.rs=t,e.rj=r})),e.req.catch((()=>{})),e}function h(e,t){let r=u(e,t),n=r.defaultConfig.handler||(()=>H(`no handler used in ${r.getType()}`)),o=pe(r);Ae(o,'unit',r.kind="effect"),r.use=e=>(T(e)||H('.use argument should be a function'),n=e,r);let s=r.finally=mt('finally'),i=r.done=s.filterMap({named:'done',fn({status:e,params:t,result:r}){if('done'===e)return{params:t,result:r}}}),f=r.fail=s.filterMap({named:'fail',fn({status:e,params:t,error:r}){if('fail'===e)return{params:t,error:r}}}),c=r.doneData=i.map({named:'doneData',fn:({result:e})=>e}),p=r.failData=f.map({named:'failData',fn:({error:e})=>e}),m=a({scope:{getHandler:r.use.getCurrent=()=>n,finally:s,handlerId:xe(o,'sid')},node:[ne({fn({params:e,req:t},{finally:r,getHandler:a,handlerId:n},o){let l,s=bt(e,t,1,r,o),i=bt(e,t,0,r,o);try{let t;t=Se(o)&&Se(o).handlers[n]||a(),l=t(e)}catch(e){return void i(e)}L(l)&&T(l.then)?l.then(s,i):s(l)}})],meta:{op:'fx',fx:'runner'}});o.scope.runner=m,o.seq.push(re({fn:(e,t,r)=>we(r)?{params:e,req:{rs(e){},rj(e){}}}:e}),ne({fn:(e,{runner:t},r)=>(l({target:t,params:e,defer:1,forkPage:Se(r)}),e.params)})),r.create=e=>{let t=g(),a={params:e,req:t};if(He){if(!Te){let e=He;t.req.finally((()=>{Ue(e)})).catch((()=>{}))}l({target:r,params:a,forkPage:He})}else l(r,a);return t.req};let h=r.inFlight=d(0,{named:'inFlight'}).on(r,(e=>e+1)).on(s,(e=>e-1));Ae(s,'needFxCounter',1),Ae(r,'needFxCounter',1);let y=r.pending=h.map({fn:e=>e>0,named:'pending'});return Pe(r,[s,i,f,c,p,y,h,m]),r}function y(e){let t;Ze(e,((r,a)=>{t=r,e=a}));let{source:r,effect:a,mapParams:n}=e,o=!R(a)&&T(a);if(n||(n=r&&!o?(e,t)=>t:e=>e),o){let e=a;a=h((([t,r])=>e(t,r)))}let s=h(e,t);Ae(s,'attached',1);let i,{runner:f}=pe(s).scope,c=({params:e,req:t},{finally:r,effect:a,isPlain:o},s)=>{let i,f=bt(e,t,0,r,s);try{i=n(e,s.a)}catch(e){return f(e)}l({target:a,params:{params:o?[i,s.a]:i,req:{rs:bt(e,t,1,r,s),rj:f}},page:s.page,defer:1})};if(r){let e;$(r)?(e=r,Pe(r,[s])):(e=p(r),Pe(s,[e])),i=[ne({fn:e=>e}),ee({store:he(e),to:"a"}),re({fn:c})]}else i=[ne({fn:c})];return Pe(a,[s]),f.scope.effect=a,f.scope.isPlain=o,f.seq.splice(0,1,...i),dt(a,s,"effect"),s}function b(...e){let[[t,r],a]=et(e),o={};return n(r,((e,r)=>{let n=o[r]=u(r,{parent:we(t),config:a});t.on(n,e),dt(t,n)})),o}function k(e,t){let r=new Set,o=new Set,l=new Set,s=new Set,i=a({family:{type:"domain"},regional:1}),f={history:{domains:r,stores:o,effects:l,events:s},graphite:i};i.meta=pt("domain",f,t,e);let[c,p,m,g]=['onEvent','onEffect','onStore','onDomain'].map(mt);f.hooks={event:c,effect:p,store:m,domain:g},f.onCreateEvent=vt(c,s,f),f.onCreateEffect=vt(p,l,f),f.onCreateStore=vt(m,o,f),f.onCreateDomain=vt(g,r,f),f.createEvent=f.event=(e,t)=>c(u(e,{parent:f,config:t})),f.createEffect=f.effect=(e,t)=>p(h(e,{parent:f,config:t})),f.createDomain=f.domain=(e,t)=>k({name:e,parent:f,config:t}),f.createStore=f.store=(e,t)=>m(d(e,{parent:f,config:t}));let y=we(f);return y&&(n(f.hooks,((e,t)=>{st({from:e,to:y.hooks[t]})})),y.hooks.domain(f)),f}function v(e){W(e);let t=N in e?e[N]():e;t.subscribe||H('expect observable to have .subscribe');let r=u(),a=ot(r);return t.subscribe({next:r,error:a,complete:a}),r}function w(e,r){let a=u(r||s(e,'merge'));return t(e,'merge','first argument'),st({from:e,to:a,meta:{op:'merge'}}),a}function S(...e){let r,n,l,s,[[i,f,m],g]=et(e);void 0===f&&L(i)&&(e=>{let t=0;return o(wt,(r=>{r in e&&(null==e[r]&&H(`sample: ${r} should be defined`),t=1)})),t})(i)&&(f=i.clock,m=i.fn,s=i.greedy,r=i.target,n=i.name,l=i.sid,i=i.source);let h=1;void 0===i&&(t(f,'sample','clock'),Array.isArray(f)&&(f=w(f)),i=f,h=0),h&&!_(i)&&(i=p(i)),void 0===f&&(f=i),t(f,'sample','clock'),n=g||n||i.shortName;let y=!!r;if(r||($(i)&&$(f)?r=d(m?m(ie(he(i)),ie(he(f))):ie(he(i)),{name:n,sid:l}):(r=u(n),c('sampleTarget',pe(r)))),$(i)){let e=he(i);Pe(i,[lt(f,r,{scope:{fn:m},node:[c('sampleSourceLoader'),!s&&Z({priority:"sampler"}),ee({store:e,to:m?"a":"stack"}),m&&re({fn:ue}),c('sampleSourceUpward',y)],meta:{op:"sample",sample:D}})]),c('sampleStoreSource',e)}else{let e=se(0),t=se(),n=se();c('sampleNonStoreSource',e,t,n),a({parent:i,node:[oe({store:t}),ee({from:"value",store:1,target:e})],family:{owners:[i,r,f],links:r},meta:{op:"sample",sample:'source'},regional:1}),Pe(i,[lt(f,r,{scope:{fn:m},node:[c('sampleSourceLoader'),oe({store:n}),ee({store:e}),ae({fn:e=>e}),!s&&Z({priority:"sampler"}),ee({store:t}),ee({store:n,to:"a"}),m&&re({fn:ce}),c('sampleSourceUpward',y)],meta:{op:"sample",sample:'clock'}})])}return r}function x(...e){let r={op:'guard'},n='guard',[[o,l],s]=et(e);s&&(r.config=s,s.name&&(n=s.name)),l||(l=o,o=l.source);let{filter:i,greedy:f,clock:c,name:d=n}=l,m=l.target||u(d,r.config),g=_(i),h=1;return void 0===o&&(t(c,'guard','clock'),Array.isArray(c)&&(c=w(c)),o=c,h=0),h&&!_(o)&&(o=p(o)),c&&(t(c,'guard','clock'),o=S({source:o,clock:c,greedy:f,fn:g?null:(e,t)=>({source:e,clock:t})})),t(m,'guard','target'),g?S({source:i,clock:o,target:a({node:[ae({fn:({guard:e})=>e}),re({fn:({data:e})=>e})],child:m,meta:r,family:{owners:[o,i,m,...[].concat(c||[])],links:m},regional:1}),fn:(e,t)=>({guard:e,data:t}),greedy:f,name:d}):(T(i)||H('`filter` should be function or unit'),lt(o,m,{scope:{fn:i},node:c?[ae({fn:({source:e,clock:t},{fn:r})=>r(e,t)}),re({fn:({source:e})=>e})]:[ae({fn:de})],meta:r})),m}function A(e,t,r){if($(e))return e;if(_(e)){let a,n=we(e);return E(e)&&(a=d(t,{parent:n,name:e.shortName,\u0254:r}).on(e,((e,t)=>t))),R(e)&&(a=d(t,{parent:n,name:e.shortName,\u0254:r}),st({from:e.doneData,to:a})),n&&n.hooks.store(a),a}let a=Array.isArray(e)?[]:{};return n(e,((e,t)=>{a[t]=$(e)?e:d(e,{name:t})})),a}function P(...e){let t,[[r,o],l]=et(e),s=!o;s&&(t=r.cases,o=r.match,r=r.source);let i=$(o),f=!_(o)&&T(o),d=!i&&!f&&L(o);t||(t={}),s||(d||H('match should be an object'),n(o,((e,r)=>{t[r]=u(l)})),t.__=u(l));let p,m=new Set([].concat(r,Object.values(t))),g=Object.keys(i||f?t:o);if(i||f)i&&m.add(o),p=[i&&Z({priority:'sampler'}),i&&ee({store:he(o),to:'a'}),ae({fn(e,t,r){let a=String(i?r.a:o(e));St(t,Fe(g,a)?a:'__',e,r)}})];else if(d){let e=se({});e.type='shape';let t,r=[ee({store:e,to:"a"}),re({fn(e,{key:t},{a:r}){r[t]=e}})],a=[];n(o,((n,o)=>{if(_(n)){t=1,a.push(o),m.add(n);let l=lt(n,[],{node:r,scope:{key:o}});if($(n)){e.current[o]=n.getState();let t=he(n);fe(e,{type:'field',field:o,from:t}),c('splitMatchStore',t,l)}}})),t&&c('splitBase',e),p=[t&&Z({priority:'sampler'}),t&&ee({store:e,to:'a'}),ae({fn(e,t,r){for(let n=0;n<g.length;n++){let l=g[n];if(Fe(a,l)?r.a[l]:o[l](e))return void St(t,l,e,r)}St(t,'__',e,r)}})]}else H('expect match to be unit, function or object');if(a({meta:{op:'split'},parent:r,scope:t,node:p,family:{type:'crosslink',owners:Array.from(m)},regional:1}),!s)return t}function C(e,{scope:t,params:r}){if(!_(e))return Promise.reject(Error('first argument should be unit'));let a=g();a.parentFork=He;let{fxCount:n}=t;n.scope.defers.push(a);let o=[e],s=[];return R(e)?s.push({params:r,req:{rs(e){a.value={status:'done',value:e}},rj(e){a.value={status:'fail',value:e}}}}):s.push(r),o.push(n),s.push(null),l({target:o,params:s,forkPage:t}),a.req}function M(e,t){if(Array.isArray(e)&&(e=new Map(e)),e instanceof Map){let r={};for(let[a,n]of e)_(a)||H('Map key should be a unit'),t&&t(a,n),r[a.sid]=n;return r}return e}function I(e,t){let r,n=e;V(e)&&(r=e,n=t);let l=(e=>{let t=a({scope:{defers:[],inFlight:0,fxID:0},node:[re({fn(e,t,r){we(r)?'finally'===xe(we(r).node,'named')?t.inFlight-=1:(t.inFlight+=1,t.fxID+=1):t.fxID+=1}}),Z({priority:"sampler"}),ne({fn(e,t){let{inFlight:r,defers:a,fxID:n}=t;r>0||0===a.length||Promise.resolve().then((()=>{t.fxID===n&&o(a.splice(0,a.length),(e=>{Ue(e.parentFork),e.rs(e.value)}))}))}})],meta:{unit:"forkInFlightCounter"}}),r=a({node:[re({fn(e,t,r){let a=we(r);if(a&&we(a)){let t=a.node;if(!xe(t,'isCombine')||'combine'!==xe(we(a).node,'op')){let a=Se(r),n=t.scope.state.id,o=xe(t,'sid');a.sidIdMap[o]=n,a.sidValuesMap[o]=e}}}})]}),n={cloneOf:e,reg:{},sidValuesMap:{},sidIdMap:{},getState:e=>'current'in e?Ke(We,n,null,e).current:((e,t)=>Ke(We,t,e,e.scope.state,1).current)(pe(e),n),kind:"scope",graphite:a({family:{type:"domain",links:[t,r]},meta:{unit:'fork'},scope:{forkInFlightCounter:t}}),additionalLinks:{},handlers:{},fxCount:t,storeChange:r};return n})(r);if(n){if(n.values){let e=M(n.values,(e=>!$(e)&&H('Values map can contain only stores as keys')));Object.assign(l.sidValuesMap,e)}n.handlers&&(l.handlers=M(n.handlers,(e=>{R(e)||H("Handlers map can contain only effects as keys"),xe(e,'attached')&&H('Handlers can`t accept attached effects')})))}return l}function q(e,{values:t}){L(t)||H('values property should be an object');let r,a,n=M(t),s=Object.getOwnPropertyNames(n),i=[],f=[];z(e)?(r=e,Object.assign(r.sidValuesMap,n),r.cloneOf||H('scope should be created from domain'),a=pe(r.cloneOf)):V(e)?a=pe(e):H('first argument of hydrate should be domain or scope'),(e=>{let t=[];(function e(r){Fe(t,r)||(t.push(r),xe(r,'unit')===D&&xe(r,'sid')&&((e,t)=>{Fe(s,t)&&(i.push(e),f.push(n[t]))})(r,xe(r,'sid')),o(r.next,e),o(me(r),e),o(ge(r),e))})(e)})(a),l({target:i,params:f,forkPage:r})}function j(e,{scope:t}={}){t||He||H('scopeBind cannot be called outside of forked .watch');let r=t||He;return R(e)?t=>{let a=g();return l({target:e,params:{params:t,req:a},forkPage:r}),a.req}:t=>(l({target:e,params:t,forkPage:r}),t)}function F(e,{ignore:t=[]}={}){let r=t.map((({sid:e})=>e)),a={};return n(e.sidValuesMap,((t,n)=>{if(r.includes(n))return;let o=e.sidIdMap[n];a[n]=o&&o in e.reg?e.reg[o].current:t})),a}let N='undefined'!=typeof Symbol&&Symbol.observable||'@@observable',D='store',_=e=>(T(e)||L(e))&&'kind'in e;const O=e=>t=>_(t)&&t.kind===e;let $=O(D),E=O("event"),R=O("effect"),V=O("domain"),z=O("scope");var B={__proto__:null,unit:_,store:$,event:E,effect:R,domain:V,scope:z};let H=e=>{throw Error(e)},L=e=>'object'==typeof e&&null!==e,T=e=>'function'==typeof e,W=e=>{L(e)||T(e)||H('expect first argument be an object')};const U=()=>{let e=0;return()=>""+ ++e};let G=U(),J=U(),K=U(),Q=(e,t)=>e.bind(null,t);const X=(e,t)=>({id:J(),type:e,data:t});let Y=0,Z=({priority:e="barrier"})=>X("barrier",{barrierID:++Y,priority:e}),ee=({from:e=D,store:t,target:r,to:a=(r?D:"stack")})=>X('mov',{from:e,store:t,to:a,target:r}),te={defined:()=>X('check',{type:'defined'}),changed:({store:e})=>X('check',{type:'changed',store:e})},re=Q(X,'compute'),ae=Q(X,"filter"),ne=Q(X,'run'),oe=({store:e})=>ee({from:"stack",target:e});var le={__proto__:null,barrier:Z,mov:ee,check:te,compute:re,filter:ae,run:ne,update:oe};let se=e=>({id:J(),current:e}),ie=({current:e})=>e,fe=(e,t)=>{e.before||(e.before=[]),e.before.push(t)},ce=(e,{fn:t},{a:r})=>t(e,r),ue=(e,{fn:t},{a:r})=>t(r,e),de=(e,{fn:t})=>t(e),pe=e=>e.graphite||e,me=e=>e.family.owners,ge=e=>e.family.links,he=e=>e.stateRef,ye=e=>e.config,be=e=>e["\u0254"],ke=e=>e.value,ve=e=>e.subscribers,we=e=>e.parent,Se=e=>e.forkPage,xe=(e,t)=>pe(e).meta[t],Ae=(e,t,r)=>pe(e).meta[t]=r,Pe=(e,t)=>{let r=pe(e);for(let e=0;e<t.length;e++){let a=pe(t[e]);"domain"!==r.family.type&&(a.family.type="crosslink"),me(a).push(r),ge(r).push(a)}},Ce=null,Me=()=>Ce&&Ce.template,Ie=e=>(e&&Ce&&Ce.sidRoot&&(e=`${Ce.sidRoot}\u0254${e}`),e),qe=({sid:e,name:t,loc:n,method:o,fn:l})=>r(a({meta:{sidRoot:Ie(e),name:t,loc:n,method:o}}),l);const je=(e=[])=>(Array.isArray(e)?e:[e]).flat().map(pe);let Fe=(e,t)=>e.includes(t),Ne=(e,t)=>{let r=e.indexOf(t);-1!==r&&e.splice(r,1)},De=null;const _e=(e,t)=>{if(!e)return t;if(!t)return e;let r,a=e.v.type===t.v.type;return(a&&e.v.id>t.v.id||!a&&"sampler"===e.v.type)&&(r=e,e=t,t=r),r=_e(e.r,t),e.r=e.l,e.l=r,e},Oe=[];let $e=0;for(;$e<5;)Oe.push({first:null,last:null,size:0}),$e+=1;const Ee=()=>{for(let e=0;e<5;e++){let t=Oe[e];if(t.size>0){if(2===e||3===e){t.size-=1;let e=De.v;return De=_e(De.l,De.r),e}1===t.size&&(t.last=null);let r=t.first;return t.first=r.r,t.size-=1,r.v}}},Re=(e,t,r,a,n,o)=>Ve(0,{a:null,b:null,node:r,parent:a,value:n,page:t,forkPage:o},e),Ve=(e,t,r,a=0)=>{let n=ze(r),o=Oe[n],l={v:{idx:e,stack:t,type:r,id:a},l:null,r:null};2===n||3===n?De=_e(De,l):(0===o.size?o.first=l:o.last.r=l,o.last=l),o.size+=1},ze=e=>{switch(e){case'child':return 0;case'pure':return 1;case"barrier":return 2;case"sampler":return 3;case"effect":return 4;default:return-1}},Be=new Set;let He,Le=1,Te=0,We=null,Ue=e=>{He=e},Ge=e=>{We=e};const Je=(e,t)=>{if(e){for(;e&&!e.reg[t];)e=we(e);if(e)return e}return null};let Ke=(e,t,r,a,n)=>{let o=Je(e,a.id);return o?o.reg[a.id]:t?(Qe(t,a,n),t.reg[a.id]):a},Qe=(e,t,r)=>{let a=e.reg;if(a[t.id])return;let n={id:t.id,current:t.current};if(t.sid&&(e.sidIdMap[t.sid]=t.id),t.sid&&t.sid in e.sidValuesMap)n.current=e.sidValuesMap[t.sid];else if((r||!t.noInit)&&t.before){let l=0;o(t.before,(t=>{switch(t.type){case"map":{let o=t.from;if(o||t.fn){o&&Qe(e,o,r);let l=o&&a[o.id].current;n.current=t.fn?t.fn(l):l}break}case'field':{Qe(e,t.from,r);let o=a[t.from.id];l||(l=1,n.current=Array.isArray(n.current)?[...n.current]:{...n.current}),n.current[t.field]=a[o.id].current;break}}}))}a[t.id]=n};const Xe=(e,{fn:t},r)=>{try{return t(ke(r),e.scope,r)}catch(t){console.error(t),e.fail=1}},Ye=e=>e.compositeName;let Ze=(e,t)=>{W(e),be(e)&&t(ye(e),be(e))},et=e=>{let t;return Ze(e[0],((r,a)=>{t=r,e=a})),[e,t]};const tt=(e,t)=>{Ne(e.next,t),Ne(me(e),t),Ne(ge(e),t)},rt=(e,t,r)=>{let a;e.next.length=0,e.seq.length=0,e.scope=null;let n=ge(e);for(;a=n.pop();)tt(a,e),(t||r&&!xe(e,'sample')||"crosslink"===a.family.type)&&rt(a,t,'on'!==xe(a,'op')&&r);for(n=me(e);a=n.pop();)tt(a,e),r&&"crosslink"===a.family.type&&rt(a,t,'on'!==xe(a,'op')&&r)},at=e=>e.clear();let nt=(e,{deep:t}={})=>{let r=0;if(e.ownerSet&&e.ownerSet.delete(e),$(e))at(ve(e));else if(V(e)){r=1;let t=e.history;at(t.events),at(t.effects),at(t.stores),at(t.domains)}rt(pe(e),!!t,r)},ot=e=>{let t=()=>nt(e);return t.unsubscribe=t,t},lt=(e,t,{node:r,scope:n,meta:o})=>a({node:r,parent:e,child:t,scope:n,meta:o,family:{owners:[e,t],links:t},regional:1}),st=e=>{let r;Ze(e,((t,a)=>{r=t,e=a}));let{from:n,to:o,meta:l={op:'forward'}}=e;return t(n,'forward','"from"'),t(o,'forward','"to"'),r&&(l.config=r),ot(a({parent:n,child:o,meta:l,family:{},regional:1}))},ft=(e,t)=>(T(t)||H('.watch argument should be a function'),ot(a({scope:{fn:t},node:[ne({fn:de})],parent:e,meta:{op:'watch'},family:{owners:e},regional:1})));const ct=(e,t)=>(L(e)&&(ct(ye(e),t),null!=e.name&&(L(e.name)?ct(e.name,t):T(e.name)?t.handler=e.name:t.name=e.name),e.loc&&(t.loc=e.loc),(e.sid||null===e.sid)&&(t.sid=e.sid),e.handler&&(t.handler=e.handler),e.updateFilter&&(t.updateFilter=e.updateFilter),we(e)&&(t.parent=we(e)),'strict'in e&&(t.strict=e.strict),e.named&&(t.named=e.named),ct(be(e),t)),t);let ut,dt=(e,t,r="event")=>{we(e)&&we(e).hooks[r](t)},pt=(e,t,r,a)=>{let n=ct({name:a,config:r},{}),o="domain"===e,l=G(),{parent:s=null,sid:i=null,strict:c=1,named:u=null}=n,d=u||n.name||(o?'':l),p=f(d,s),m={unit:t.kind=e,name:t.shortName=d,sid:t.sid=Ie(i),named:u,unitId:t.id=l};if(t.parent=s,t.compositeName=p,t.defaultConfig=n,t.thru=e=>e(t),t.getType=()=>p.fullName,!o){t.subscribe=e=>(W(e),t.watch(T(e)?e:t=>{e.next&&e.next(t)})),t[N]=()=>t;let e=Me();e&&(m.nativeTemplate=e)}return ut=c,m},mt=e=>u({named:e});const gt=(e,t,r,a)=>{let n;L(r)&&(n=r,r=r.fn);let o=u({name:`${e.shortName} \u2192 *`,\u0254:n});return lt(e,o,{scope:{fn:r},node:a,meta:{op:t}}),o},ht=(e,t,r,a,n,o)=>{let l=he(t),s=[ee({store:l,to:"a"}),re({fn:a?ue:ce}),te.defined(),te.changed({store:l}),o&&ae({fn:(e,t,{a:r})=>o(e,r)}),oe({store:l})];return c('storeOnMap',l,s,$(e)&&he(e)),lt(e,t,{scope:{fn:n},node:s,meta:{op:r}})},yt=(e,t,r,a,o)=>{let l=e?e=>e.slice():e=>({...e}),i=e?[]:{},f=l(i),u=se(f),p=se(1);u.type=e?'list':'shape',u.noInit=1,c('combineBase',u,p);let m=d(f,{name:a||s(r)}),g=he(m);g.noInit=1,Ae(m,'isCombine',1);let h=[te.defined(),ee({store:u,to:"a"}),ae({fn:(e,{key:t},{a:r})=>e!==r[t]}),ee({store:p,to:'b'}),re({fn(e,{clone:t,key:r,spread:a},n){a&&n.b&&(n.a=t(n.a)),n.a[r]=e}}),ee({from:"a",target:u}),ee({from:"value",store:0,target:p}),Z({priority:"barrier"}),ee({from:"value",store:1,target:p}),ee({store:u}),o&&re({fn:de}),te.changed({store:g})];return n(r,((e,r)=>{if(!$(e))return void(f[r]=i[r]=e);i[r]=e.defaultState,f[r]=e.getState();let a=lt(e,m,{scope:{key:r,clone:l,fn:o,spread:t},node:h,meta:{op:'combine'}}),n=he(e);fe(u,{type:'field',field:r,from:n}),c('combineField',n,a)})),m.defaultShape=r,fe(g,{type:"map",from:u,fn:o}),Me()||(m.defaultState=o?g.current=o(f):i),m};let bt=(e,t,r,a,n)=>o=>l({target:[a,kt],params:[r?{status:'done',params:e,result:o}:{status:'fail',params:e,error:o},{fn:r?t.rs:t.rj,value:o}],defer:1,page:n.page,forkPage:Se(n)}),kt=a({node:[ne({fn({fn:e,value:t}){e(t)}})],meta:{op:'fx',fx:'sidechain'}});const vt=(e,t,r)=>(e.create=t=>(l(e,t),t),pe(e).seq.push(re({fn:(e,t,r)=>(r.forkPage=null,e)})),e.watch((e=>{Pe(r,[e]),t.add(e),e.ownerSet||(e.ownerSet=t),we(e)||(e.parent=r)})),Pe(r,[e]),r=>(t.forEach(r),e.watch(r))),wt=['source','clock','target'],St=(e,t,r,a)=>{let n=e[t];n&&l({target:n,params:Array.isArray(n)?n.map((()=>r)):r,defer:1,stack:a})},xt="21.8.12";export{C as allSettled,y as attach,nt as clearNode,p as combine,b as createApi,k as createDomain,h as createEffect,u as createEvent,a as createNode,d as createStore,m as createStoreObject,I as fork,st as forward,v as fromObservable,x as guard,q as hydrate,B as is,l as launch,w as merge,A as restore,S as sample,j as scopeBind,F as serialize,i as setStoreName,P as split,le as step,xt as version,qe as withFactory,r as withRegion};
//# sourceMappingURL=effector.mjs.map
